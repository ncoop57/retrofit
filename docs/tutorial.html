---

title: Tutorial


keywords: fastai
sidebar: home_sidebar

summary: "API details."
description: "API details."
nb_path: "nbs/02_tutorial.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_tutorial.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="c1"># from codecarbon import EmissionsTracker</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks</span> <span class="k">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">TQDMProgressBar</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="k">import</span> <span class="n">WandbLogger</span>
<span class="kn">from</span> <span class="nn">retrofit.data</span> <span class="k">import</span> <span class="n">RetroDataset</span>
<span class="kn">from</span> <span class="nn">retrofit.model</span> <span class="k">import</span> <span class="n">RetroFitModel</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="k">import</span> <span class="n">AutoTokenizer</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;whole_func_string&quot;</span>
<span class="n">encoder_name</span> <span class="o">=</span> <span class="s2">&quot;distilbert-base-uncased&quot;</span>
<span class="n">decoder_name</span> <span class="o">=</span> <span class="s2">&quot;gpt2&quot;</span>
<span class="n">encoder_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">encoder_name</span><span class="p">)</span>
<span class="n">decoder_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">decoder_name</span><span class="p">)</span>
<span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">decoder_tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
<span class="n">retro_ds</span> <span class="o">=</span> <span class="n">RetroDataset</span><span class="p">(</span>
    <span class="s2">&quot;code_search_net&quot;</span><span class="p">,</span>
    <span class="s2">&quot;flax-sentence-embeddings/st-codesearch-distilroberta-base&quot;</span><span class="p">,</span>
    <span class="n">encoder_tokenizer</span><span class="p">,</span>
    <span class="n">decoder_tokenizer</span><span class="p">,</span>
    <span class="n">dataset_config</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">n_perc</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RetroFitModel</span><span class="p">(</span>
    <span class="n">encoder_tokenizer</span><span class="p">,</span>
    <span class="n">decoder_tokenizer</span><span class="p">,</span>
    <span class="n">encoder_name</span><span class="p">,</span>
    <span class="n">decoder_name</span><span class="p">,</span>
    <span class="n">column</span><span class="p">,</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">lr</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
    <span class="n">freeze_decoder</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_module</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a model with a given training data loader, validation data loader,</span>
<span class="sd">    optimizer, scheduler, loss function, metrics, and callbacks.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (pl.LightningModule): The model to train.</span>
<span class="sd">        data_module (pl.LightningDataModule): The data module to use for training.</span>
<span class="sd">        num_epochs (int): The number of epochs to train for.</span>
<span class="sd">        output_dir (pathlib.Path): The directory to save the model to.</span>
<span class="sd">        name (str): The name of the model.</span>
<span class="sd">    Returns:</span>
<span class="sd">        best_model_path (str): The path to the best model&#39;s checkpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pl.seed_everything(115, workers=True)</span>
    <span class="n">wandb_logger</span> <span class="o">=</span> <span class="n">WandbLogger</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s2">&quot;Retrofit&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># saves a file like: my/path/sample-mnist-epoch=02-val_loss=0.32.ckpt</span>
    <span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
        <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
        <span class="n">dirpath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span><span class="p">),</span>
        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;retrofit-</span><span class="si">{epoch:02d}</span><span class="s2">-</span><span class="si">{val_loss:.2f}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">save_top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">wandb_logger</span><span class="p">,</span>
        <span class="n">default_root_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span><span class="p">),</span>
        <span class="n">gpus</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">(),</span>
        <span class="n">max_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">limit_train_batches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">limit_val_batches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">checkpoint_callback</span><span class="p">,</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">),</span>
            <span class="n">TQDMProgressBar</span><span class="p">(</span><span class="n">refresh_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># tracker = EmissionsTracker(output_dir=output_dir.parent.parent, project_name=name)</span>

    <span class="c1"># train the model and track emissions</span>
    <span class="c1"># tracker.start()</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_module</span><span class="p">)</span>
    <span class="c1"># tracker.stop()</span>

    <span class="c1"># save the best model to wandb</span>
    <span class="c1"># best_model_path = checkpoint_callback.best_model_path</span>
    <span class="c1"># if best_model_path is not None:</span>
    <span class="c1">#     wandb.save(best_model_path)</span>

    <span class="c1"># # save the emissions csv file</span>
    <span class="c1"># wandb.save(str(output_dir.parent.parent / &quot;emissions.csv&quot;))</span>

    <span class="k">return</span> <span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">best_model_path</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/workspace/retrofit/data/output/&quot;</span><span class="p">)</span>
<span class="n">best_model_path</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">retro_ds</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="n">out_dir</span> <span class="o">/</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># model = RetroFitModel.load_from_checkpoint(best_model_path)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

